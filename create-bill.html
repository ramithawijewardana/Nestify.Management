<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Bill - Nestify Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .input-focus:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .success-message {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <h1 class="text-2xl font-bold text-gray-900">Nestify Management</h1>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="window.location.href='billing.html'" class="text-gray-700 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Billing
                    </button>
                    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-4xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-2">Create New Bill</h2>
            <p class="text-gray-600">Generate bills for residents with automatic recurring options</p>
        </div>

        <!-- Success Message -->
        <div id="successMessage" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-6 success-message">
            <div class="flex items-center">
                <i class="fas fa-check-circle mr-2"></i>
                <span id="successText">Bill created successfully!</span>
            </div>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6">
            <div class="flex items-center">
                <i class="fas fa-exclamation-circle mr-2"></i>
                <span id="errorText">An error occurred. Please try again.</span>
            </div>
        </div>

        <!-- Form Card -->
        <div class="bg-white rounded-lg shadow-lg p-6 md:p-8">
            <form id="billForm" class="space-y-6">
                <!-- Resident Selection -->
                <div>
                    <label for="residentSelect" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-user mr-2"></i>Select Resident *
                    </label>
                    <div class="relative">
                        <select id="residentSelect" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent input-focus appearance-none bg-white">
                            <option value="">Loading residents...</option>
                        </select>
                        <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                            <i class="fas fa-chevron-down text-gray-400"></i>
                        </div>
                    </div>
                </div>

                <!-- Amount -->
                <div>
                    <label for="amount" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-dollar-sign mr-2"></i>Amount (LKR) *
                    </label>
                    <input type="number" id="amount" step="0.01" min="0" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent input-focus"
                           placeholder="Enter amount">
                </div>

                <!-- Due Date -->
                <div>
                    <label for="dueDate" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-calendar mr-2"></i>Due Date *
                    </label>
                    <input type="date" id="dueDate" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent input-focus">
                </div>

                <!-- Description -->
                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-file-text mr-2"></i>Description *
                    </label>
                    <textarea id="description" rows="4" required 
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent input-focus resize-none"
                              placeholder="Enter bill description (e.g., Monthly maintenance fee, Parking violation fine, etc.)"></textarea>
                </div>

                <!-- Recurring Option -->
                <div class="flex items-center">
                    <input type="checkbox" id="isRecurring" 
                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="isRecurring" class="ml-2 block text-sm text-gray-700">
                        <i class="fas fa-repeat mr-2"></i>Make this a recurring monthly bill
                    </label>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-4 pt-6">
                    <button type="submit" id="submitBtn" 
                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition duration-200 btn-primary">
                        <i class="fas fa-save mr-2"></i>Create Bill
                    </button>
                    <button type="button" onclick="clearForm()" 
                            class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-medium py-3 px-6 rounded-lg transition duration-200">
                        <i class="fas fa-eraser mr-2"></i>Clear Form
                    </button>
                </div>
            </form>
        </div>

    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 flex items-center space-x-3">
            <i class="fas fa-spinner fa-spin text-blue-600"></i>
            <span class="text-gray-700">Creating bill...</span>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC3Zbnm-_ghWQiFiDZcQCE4MkR_4WeDAr8",
            authDomain: "nestify-af7a6.firebaseapp.com",
            projectId: "nestify-af7a6",
            storageBucket: "nestify-af7a6.appspot.com",
            messagingSenderId: "462014928709",
            appId: "1:462014928709:web:91a79060ea330c5bba902c"
        };

        // Global variables
        let residents = [];
        let currentUser = null;
        let db, auth;

        // Initialize Firebase when page loads
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Initialize Firebase
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                
                console.log('Firebase initialized successfully');
                
                // Initialize the page
                checkAuth();
                loadResidents();
                setupFormValidation();
                
                // Add a test button for creating sample residents (for testing)
                addTestButton();
                
            } catch (error) {
                console.error('Firebase initialization failed:', error);
                showError('Failed to initialize Firebase. Please refresh the page.');
            }
        });

        // Check authentication
        function checkAuth() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    console.log('User authenticated:', user.email);
                } else {
                    // For now, allow access without authentication
                    console.log('No user authenticated, but allowing access to create bill page');
                    currentUser = null;
                }
            });
        }

        // Load residents from Firestore
        async function loadResidents() {
            try {
                if (!db) {
                    throw new Error('Firebase not initialized yet');
                }
                
                console.log('Loading residents from Firebase...');
                console.log('Firebase config:', firebaseConfig);
                
                // Update the dropdown to show loading state
                const select = document.getElementById('residentSelect');
                select.innerHTML = '<option value="">Loading residents...</option>';
                
                // Use the correct Firebase path structure
                const residentsSnapshot = await db.collection('apartment_1').doc('1HgCK9tLiQnkOURHXBtM').collection('residents').get();
                residents = [];
                
                console.log('Residents snapshot size:', residentsSnapshot.size);
                console.log('Residents snapshot empty:', residentsSnapshot.empty);
                
                if (residentsSnapshot.empty) {
                    console.log('No residents found in database');
                    select.innerHTML = '<option value="">No residents found - Click "Create Test Residents" below</option>';
                    showError('No residents found in the database. Use the "Create Test Residents" button below to add some test data.');
                    return;
                }
                
                residentsSnapshot.forEach(doc => {
                    const data = doc.data();
                    console.log('Resident data:', doc.id, data);
                    residents.push({
                        id: doc.id,
                        name: data.name || 'Unknown',
                        room: data.room || 'N/A',
                        email: data.email || 'No email'
                    });
                });

                // Sort residents by name
                residents.sort((a, b) => a.name.localeCompare(b.name));

                // Populate dropdown
                select.innerHTML = '<option value="">Select a resident...</option>';
                
                residents.forEach(resident => {
                    const option = document.createElement('option');
                    option.value = resident.id;
                    option.textContent = `${resident.name} (Room ${resident.room})`;
                    select.appendChild(option);
                });

                console.log('Successfully loaded residents:', residents.length);
                hideMessages(); // Hide any error messages
                
            } catch (error) {
                console.error('Error loading residents:', error);
                console.error('Error details:', error.message, error.code);
                
                // Fallback: Create a hardcoded resident for testing
                console.log('Creating fallback resident for testing...');
                residents = [{
                    id: 'QAeqYDU69VSUGZYotfVl',
                    name: 'Ramitha Wijayawardana',
                    room: 1,
                    email: 'ramitha@example.com'
                }];
                
                const select = document.getElementById('residentSelect');
                select.innerHTML = '<option value="">Select a resident...</option>';
                
                residents.forEach(resident => {
                    const option = document.createElement('option');
                    option.value = resident.id;
                    option.textContent = `${resident.name} (Room ${resident.room}) - Fallback`;
                    select.appendChild(option);
                });
                
                showError(`Firebase connection failed: ${error.message}. Using fallback resident for testing. Check browser console for details.`);
            }
        }


        // Get resident name by ID
        function getResidentName(residentId) {
            const resident = residents.find(r => r.id === residentId);
            return resident ? `${resident.name} (Room ${resident.room})` : 'Unknown Resident';
        }

        // Setup form validation
        function setupFormValidation() {
            const form = document.getElementById('billForm');
            const submitBtn = document.getElementById('submitBtn');
            
            form.addEventListener('input', function() {
                const isValid = form.checkValidity();
                submitBtn.disabled = !isValid;
                submitBtn.classList.toggle('opacity-50', !isValid);
            });
        }

        // Handle form submission
        document.getElementById('billForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                residentId: document.getElementById('residentSelect').value,
                amount: parseFloat(document.getElementById('amount').value),
                dueDate: new Date(document.getElementById('dueDate').value),
                description: document.getElementById('description').value.trim(),
                isRecurring: document.getElementById('isRecurring').checked,
                createdAt: new Date()
            };

            // Validate form
            if (!formData.residentId || !formData.amount || !formData.dueDate || !formData.description) {
                showError('Please fill in all required fields.');
                return;
            }

            if (formData.amount <= 0) {
                showError('Amount must be greater than 0.');
                return;
            }

            if (formData.dueDate < new Date()) {
                showError('Due date cannot be in the past.');
                return;
            }

            try {
                if (!db) {
                    throw new Error('Firebase not initialized yet');
                }
                
                showLoading(true);
                
                // Generate unique bill ID
                const billId = 'BILL_' + Date.now();
                
                // Prepare bill data for the specific resident's billing collection
                const billData = {
                    id: billId,
                    residentId: formData.residentId,
                    apartmentId: 'apartment_1',
                    baseAmount: formData.amount,
                    lateFees: 0,
                    additionalCharges: 0,
                    dueDate: firebase.firestore.Timestamp.fromDate(formData.dueDate),
                    statementDate: firebase.firestore.Timestamp.fromDate(new Date()),
                    description: formData.description,
                    status: 'PENDING',
                    isOverdue: false,
                    isRecurring: formData.isRecurring,
                    createdAt: firebase.firestore.Timestamp.fromDate(formData.createdAt)
                };
                
                console.log('Saving bill to resident billing collection:', billData);
                
                // Save to the resident's billing collection (same path as the mobile app uses)
                await db.collection('apartment_1')
                    .doc('1HgCK9tLiQnkOURHXBtM')
                    .collection('residents')
                    .doc(formData.residentId)
                    .collection('billing')
                    .doc(billId)
                    .set(billData);
                
                console.log('Bill saved successfully to:', `apartment_1/1HgCK9tLiQnkOURHXBtM/residents/${formData.residentId}/billing/${billId}`);
                
                // Show success message
                showSuccess(`Bill created successfully for ${getResidentName(formData.residentId)}! Bill ID: ${billId}`);
                
                // Clear form
                clearForm();
                
            } catch (error) {
                console.error('Error creating bill:', error);
                showError('Failed to create bill. Please try again. Error: ' + error.message);
            } finally {
                showLoading(false);
            }
        });

        // Clear form
        function clearForm() {
            document.getElementById('billForm').reset();
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('submitBtn').classList.remove('opacity-50');
            hideMessages();
        }

        // Show loading overlay
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        // Show success message
        function showSuccess(message) {
            hideMessages();
            const successDiv = document.getElementById('successMessage');
            const successText = document.getElementById('successText');
            successText.textContent = message;
            successDiv.classList.remove('hidden');
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                successDiv.classList.add('hidden');
            }, 5000);
        }

        // Show error message
        function showError(message) {
            hideMessages();
            const errorDiv = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            errorText.textContent = message;
            errorDiv.classList.remove('hidden');
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 5000);
        }

        // Hide all messages
        function hideMessages() {
            document.getElementById('successMessage').classList.add('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
        }

        // Logout function
        function logout() {
            if (currentUser) {
                auth.signOut().then(() => {
                    window.location.href = 'login.html';
                }).catch((error) => {
                    console.error('Error signing out:', error);
                });
            } else {
                // If no user is authenticated, just go back to billing page
                window.location.href = 'billing.html';
            }
        }

        // Set minimum date to today
        document.getElementById('dueDate').min = new Date().toISOString().split('T')[0];
        
        // Add test button for creating sample residents
        function addTestButton() {
            const formCard = document.querySelector('.bg-white.rounded-lg.shadow-lg.p-6');
            if (formCard) {
                const testButton = document.createElement('div');
                testButton.className = 'mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg';
                testButton.innerHTML = `
                    <p class="text-sm text-yellow-800 mb-2">Having trouble loading residents?</p>
                    <div class="flex gap-2">
                        <button onclick="loadResidents()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm">
                            <i class="fas fa-refresh mr-2"></i>Refresh Residents
                        </button>
                        <button onclick="createTestResidents()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded text-sm">
                            <i class="fas fa-plus mr-2"></i>Create Test Residents
                        </button>
                    </div>
                    <p class="text-xs text-yellow-600 mt-2">Check browser console (F12) for detailed error information</p>
                `;
                formCard.appendChild(testButton);
            }
        }
        
        // Create test residents for testing
        async function createTestResidents() {
            try {
                if (!db) {
                    throw new Error('Firebase not initialized yet');
                }
                
                showLoading(true);
                
                const testResidents = [
                    { name: 'Ramitha Wijayawardana', room: 1, email: 'ramitha@example.com' },
                    { name: 'John Smith', room: 2, email: 'john@example.com' },
                    { name: 'Sarah Johnson', room: 3, email: 'sarah@example.com' }
                ];
                
                for (const resident of testResidents) {
                    const residentData = {
                        name: resident.name,
                        room: resident.room,
                        email: resident.email,
                        apartmentId: 'apartment_1',
                        createdAt: firebase.firestore.Timestamp.fromDate(new Date())
                    };
                    
                    await db.collection('apartment_1')
                        .doc('1HgCK9tLiQnkOURHXBtM')
                        .collection('residents')
                        .add(residentData);
                }
                
                showSuccess('Test residents created successfully! Refreshing...');
                setTimeout(() => {
                    loadResidents();
                }, 1000);
                
            } catch (error) {
                console.error('Error creating test residents:', error);
                showError('Failed to create test residents: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
    </script>
</body>
</html>
